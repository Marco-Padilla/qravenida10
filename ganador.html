<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Av10 - Ganadores</title>
    <link rel="icon" href="/public/favicon.png" />
    <link rel="stylesheet" href="/public/css/styles.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="p-4 bg-light">
    <div class="container">
      <h2 class="text-center mb-4">Participantes Registrados</h2>
      <ul id="lista-participantes" class="list-group mb-4"></ul>
      <button id="elegirGanador" class="btn btn-success w-100">
        Elegir Ganador
      </button>
    </div>

    <script>
      let participantes = [];

      // FunciÃ³n para obtener los Ãºltimos 3 dÃ­gitos de la cÃ©dula
      function obtenerUltimosTresDigitos(cedula) {
        return cedula.slice(-3);
      }

      async function cargarParticipantes() {
        try {
          const res = await fetch("http://localhost:3000/api/participantes");
          participantes = await res.json();

          console.log(participantes); // Imprime los participantes para que puedas ver la estructura

          const lista = document.getElementById("lista-participantes");
          lista.innerHTML = "";

          participantes.forEach((p) => {
            const item = document.createElement("li");
            item.className = "list-group-item";
            // Mostrar solo los Ãºltimos 3 dÃ­gitos de la cÃ©dula y el telÃ©fono completo
            const cedulaUltimos3 = obtenerUltimosTresDigitos(p.cedula);

            // Si 'telefono' no existe, muestra un mensaje de error
            if (p.telefono) {
              item.textContent = `${p.nombre} - ${cedulaUltimos3} - ${p.telefono}`;
            } else {
              item.textContent = `${p.nombre} - ${cedulaUltimos3} - TelÃ©fono no disponible`;
            }

            lista.appendChild(item);
          });
        } catch (error) {
          console.error(error);
          Swal.fire(
            "Error",
            "No se pudieron cargar los participantes",
            "error"
          );
        }
      }

      document.getElementById("elegirGanador").addEventListener("click", () => {
        if (participantes.length === 0)
          return Swal.fire("Error", "No hay participantes", "error");

        const ganador =
          participantes[Math.floor(Math.random() * participantes.length)];
        Swal.fire(
          "ðŸŽ‰ Â¡Ganador!",
          `${ganador.nombre} - ${obtenerUltimosTresDigitos(ganador.cedula)} - ${
            ganador.telefono || "TelÃ©fono no disponible"
          }`,
          "success"
        );
      });

      cargarParticipantes();
    </script>
  </body>
</html>
